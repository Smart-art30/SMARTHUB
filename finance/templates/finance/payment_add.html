{% extends 'base.html' %}
{% block title %}Add Payment{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Add Payment</h2>

    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}

    <form method="POST" class="needs-validation" novalidate>
        {% csrf_token %}

        <!-- Select Class -->
        <div class="mb-3">
            <label for="student_class" class="form-label">Class</label>
            <select class="form-select" id="student_class">
                <option value="">Select Class</option>
                {% for cls in classes %}
                    <option value="{{ cls.id }}">{{ cls.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Select Student -->
        <div class="mb-3">
            <label for="student" class="form-label">Student</label>
            <select class="form-select" id="student" name="student">
                <option value="">Select Student</option>
            </select>
        </div>

        <!-- Select Invoice -->
        <div class="mb-3">
            <label for="invoice" class="form-label">Invoice</label>
            <select class="form-select" id="invoice" name="invoice" required>
                <option value="">Select Invoice</option>
            </select>
        </div>

        <!-- Payment Details -->
        <div class="mb-3">
            <label for="amount" class="form-label">Amount</label>
            <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
        </div>

        <div class="mb-3">
            <label for="payment_method" class="form-label">Payment Method</label>
            <select class="form-select" id="payment_method" name="payment_method" required>
                <option value="">Select Method</option>
                <option value="cash">Cash</option>
                <option value="bank">Bank</option>
                <option value="mpesa">M-Pesa</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="settlement_account" class="form-label">Settlement Account</label>
            <select class="form-select" id="settlement_account" name="settlement_account" required>
                <option value="">Select Account</option>
                <option value="cash">Cash</option>
                <option value="bank">Bank</option>
                <option value="mpesa">M-Pesa</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="transaction_reference" class="form-label">Transaction Reference (optional)</label>
            <input type="text" class="form-control" id="transaction_reference" name="transaction_reference">
        </div>

        <button type="submit" class="btn btn-success">Record Payment</button>
        <a href="{% url 'finance:payment_list' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
// Preload student and invoice data as JS arrays
const students = [
    {% for student in students %}
    {id: '{{ student.id }}', full_name: '{{ student.first_name }} {{ student.last_name }}', class_id: '{{ student.student_class.id }}'},
    {% endfor %}
];

const invoices = [
    {% for invoice in invoices %}
    {id: '{{ invoice.id }}', student_id: '{{ invoice.student.id }}', text: '{{ invoice.fee_structure.student_class.name }} | {{ invoice.fee_structure.term }} {{ invoice.fee_structure.year }} | Total: {{ invoice.total_amount }} | Paid: {{ invoice.total_paid|default:"0" }} | Balance: {{ invoice.balance|default:"0" }}'},
    {% endfor %}
];

const classSelect = document.getElementById('student_class');
const studentSelect = document.getElementById('student');
const invoiceSelect = document.getElementById('invoice');

// Rebuild student options when class changes
classSelect.addEventListener('change', () => {
    const selectedClass = classSelect.value;
    studentSelect.innerHTML = '<option value="">Select Student</option>';

    students.forEach(s => {
        if (s.class_id === selectedClass) {
            const option = document.createElement('option');
            option.value = s.id;
            option.textContent = s.full_name;
            studentSelect.appendChild(option);
        }
    });

    invoiceSelect.innerHTML = '<option value="">Select Invoice</option>';
});

// Rebuild invoice options when student changes
studentSelect.addEventListener('change', () => {
    const selectedStudent = studentSelect.value;
    invoiceSelect.innerHTML = '<option value="">Select Invoice</option>';

    invoices.forEach(i => {
        if (i.student_id === selectedStudent) {
            const option = document.createElement('option');
            option.value = i.id;
            option.textContent = i.text;
            invoiceSelect.appendChild(option);
        }
    });
});
</script>
{% endblock %}
