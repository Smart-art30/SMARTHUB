{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h3>Enter Marks - Class {{ exam.school_class.name }}</h3>
    <p>
        <strong>Exam:</strong> {{ exam.name }} ({{ exam.term }} {{ exam.year }})<br>
        <strong>Max Marks:</strong> {{ exam.max_mark }}
    </p>

    {% if students %}
    <form method="post">
        {% csrf_token %}
        <div class="table-responsive">
            <table id="marks-table" class="table table-bordered table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th style="font-size:0.7rem;">Rank</th>
                        <th style="font-size:0.7rem;">Student</th>
                        {% for subject in subjects %}
                            <th style="font-size:0.7rem;" data-subject-id="{{ subject.id }}">
                                {{ subject.short_name|default:subject.code|default:subject.name }}
                            </th>
                            <th style="font-size:0.7rem;">Rubric</th>
                        {% endfor %}
                        <th style="font-size:0.7rem;">Total</th>
                        <th style="font-size:0.7rem;">Average</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td class="rank-cell"></td>
                        <td>{{ student.user.get_full_name }}</td>
                        {% for item in student.marks_list %}
                            <td>
                                <input type="number"
                                       name="marks_{{ student.id }}_{{ item.subject.id }}"
                                       class="form-control form-control-sm mark-input"
                                       value="{{ item.mark }}"
                                       max="{{ exam.max_mark }}"
                                       min="0"
                                       step="0.1">
                            </td>
                            <td class="rubric-cell text-center"></td>
                        {% endfor %}
                        <td class="total-cell"></td>
                        <td class="average-cell"></td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-dark">
                    <tr>
                        <th colspan="2" style="font-size:0.7rem;">Subject Total</th>
                        {% for subject in subjects %}
                            <th class="subject-total" data-subject-id="{{ subject.id }}"></th>
                            <th></th>
                        {% endfor %}
                        <th></th>
                        <th></th>
                    </tr>
                    <tr>
                        <th colspan="2" style="font-size:0.7rem;">Subject Mean</th>
                        {% for subject in subjects %}
                            <th class="subject-mean" data-subject-id="{{ subject.id }}"></th>
                            <th></th>
                        {% endfor %}
                        <th></th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>
        <button type="submit" class="btn btn-success mt-2">Save Marks</button>
    </form>

    <!-- Exam Summary -->
    <h4 class="mt-4">Exam Summary (Subjects Ranked by Mean)</h4>
    <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover table-sm">
            <thead class="table-dark">
                <tr>
                    <th style="font-size:0.7rem;">Rank</th>
                    <th style="font-size:0.7rem;">Subject</th>
                    <th style="font-size:0.7rem;">Mean Score</th>
                </tr>
            </thead>
            <tbody id="exam-summary-body">
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>

    {% else %}
    <div class="alert alert-warning">
        No students found in this class.
    </div>
    {% endif %}
</div>

<style>
.table td, .table th { padding: 0.1rem !important; font-size: 0.7rem; }
input.mark-input { width: 50px; max-width: 100%; height: calc(1rem + 2px); font-size: 0.65rem; }
.rubric-cell { font-weight:bold; text-align:center; font-size:0.7rem; }

/* Rubrics */
.rubric-ee { background-color: #28a745; color: #fff; }
.rubric-me { background-color: #ffc107; color: #212529; }
.rubric-ae { background-color: #fd7e14; color: #fff; }
.rubric-be { background-color: #dc3545; color: #fff; }

/* Top 3 ranks */
.rank-1 { background-color: gold !important; font-weight: bold; }
.rank-2 { background-color: silver !important; font-weight: bold; }
.rank-3 { background-color: #cd7f32 !important; font-weight: bold; }

/* Landscape print */
@media print {
    body { font-size: 8pt; }
    table { page-break-inside: auto; width: 100%; font-size: 8pt; }
    tr { page-break-inside: avoid; page-break-after: auto; }
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }
    button { display: none; }
    input { border: none; font-size: 8pt; width: 40px; }
    @page { size: A4 landscape; margin: 5mm; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const table = document.getElementById('marks-table');

    function getRubric(mark){
        mark = parseFloat(mark);
        if(isNaN(mark)) return '';
        if(mark >= 80) return 'E.E';
        if(mark >= 60) return 'M.E';
        if(mark >= 40) return 'A.E';
        return 'B.E';
    }

    function getRubricClass(mark){
        mark = parseFloat(mark);
        if(isNaN(mark)) return '';
        if(mark >= 80) return 'rubric-ee';
        if(mark >= 60) return 'rubric-me';
        if(mark >= 40) return 'rubric-ae';
        return 'rubric-be';
    }

    function updateMarks(){
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const subjectSums = {};
        const subjectCounts = {};

        table.querySelectorAll('.mark-input').forEach(input=>{
            const subjId = input.name.split('_')[2];
            subjectSums[subjId] = 0;
            subjectCounts[subjId] = 0;
        });

        // Student totals & rubrics
        rows.forEach(row=>{
            let total = 0;
            row.querySelectorAll('.mark-input').forEach(input=>{
                const val = parseFloat(input.value);
                const subjId = input.name.split('_')[2];
                if(!isNaN(val)){
                    total += val;
                    subjectSums[subjId] += val;
                    subjectCounts[subjId] += 1;
                }
                const rubricCell = input.parentElement.nextElementSibling;
                rubricCell.textContent = getRubric(val);
                rubricCell.className = 'rubric-cell ' + getRubricClass(val);
            });
            row.querySelector('.total-cell').textContent = total.toFixed(1);
            row.querySelector('.average-cell').textContent = (total / row.querySelectorAll('.mark-input').length).toFixed(2);
            row.dataset.total = total;
        });

        // Rank students (left column)
        rows.sort((a,b)=>parseFloat(b.dataset.total) - parseFloat(a.dataset.total));
        rows.forEach((row,index)=>{
            row.querySelector('.rank-cell').textContent = index + 1;
            row.classList.remove('rank-1','rank-2','rank-3');
            if(index===0) row.classList.add('rank-1');
            if(index===1) row.classList.add('rank-2');
            if(index===2) row.classList.add('rank-3');
            row.parentElement.appendChild(row);
        });

        // Subject totals & means
        table.querySelectorAll('.subject-total').forEach(th=>{
            const subjId = th.dataset.subjectId;
            th.textContent = subjectSums[subjId].toFixed(1);
        });
        table.querySelectorAll('.subject-mean').forEach(th=>{
            const subjId = th.dataset.subjectId;
            th.textContent = (subjectSums[subjId]/subjectCounts[subjId]).toFixed(2);
        });

        // Exam summary: subjects ranked by mean
        const summaryBody = document.getElementById('exam-summary-body');
        if(summaryBody){
            summaryBody.innerHTML = '';
            const subjectData = [];
            table.querySelectorAll('th[data-subject-id]').forEach(th=>{
                const subjId = th.dataset.subjectId;
                const meanTh = table.querySelector(`.subject-mean[data-subject-id="${subjId}"]`);
                if(meanTh){
                    const mean = parseFloat(meanTh.textContent);
                    const subjName = th.textContent; // guaranteed short_name/code/name
                    subjectData.push({id: subjId, name: subjName, mean: mean});
                }
            });
            subjectData.sort((a,b)=>b.mean - a.mean);
            subjectData.forEach((subj,index)=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="font-size:0.7rem;">${index+1}</td>
                                <td style="font-size:0.7rem;">${subj.name}</td>
                                <td style="font-size:0.7rem;">${subj.mean.toFixed(2)}</td>`;
                summaryBody.appendChild(tr);
            });
        }
    }

    table.querySelectorAll('.mark-input').forEach(input=>{
        input.addEventListener('input', updateMarks);
    });

    updateMarks();
});
</script>
{% endblock %}
