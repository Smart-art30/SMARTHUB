{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-3 watermark-container">

    <!-- SCHOOL LOGO HEADER - NO SMARTHUB/BRANDING -->
    <div class="d-flex align-items-center mb-2 print-header">
        <img src="{% if school_logo_url %}{{ school_logo_url }}{% else %}{% static 'images/school_logo.png' %}{% endif %}" 
             style="height:45px; margin-right:10px; flex-shrink: 0;">

        <div class="flex-grow-1">
            <h6 class="mb-0 exam-title">Marks Entry â€“ {{ exam.name }}</h6>
            <div class="exam-info">Class: {{ school_class }} | Max: {{ exam.max_mark }}</div>
            <div class="exam-info">Facilitator: <strong>{{ request.user.get_full_name|default:"____________________" }}</strong></div>
        </div>

        <div class="ms-auto no-print">
            <button onclick="window.print()" class="btn btn-sm btn-outline-dark me-1">ðŸ–¨ Print</button>
            <button onclick="downloadPDF()" class="btn btn-sm btn-outline-primary">â¬‡ PDF</button>
        </div>
    </div>

    <!-- VISIBLE SCHOOL LOGO WATERMARKS -->
    <img src="{% static 'images/school_logo.png' %}" class="watermark diagonal-1">
    <img src="{% static 'images/school_logo.png' %}" class="watermark diagonal-2">
    <img src="{% static 'images/school_logo.png' %}" class="watermark horizontal-center">

    <!-- ENLARGED TABLE -->
    <div class="table-container">
        <div class="table-responsive">
            <table id="marks-table" class="table table-sm table-bordered marks-table">
                <thead>
                    <tr class="table-primary">
                        <th style="width:35px">#</th>
                        <th style="width:150px" class="text-start">Student</th>
                        {% for subject in subjects %}
                            <th style="width:35px">{{ subject.short_name|default:subject.name|slice:":3" }}</th>
                            <th style="width:20px" class="rubric-header">R</th>
                        {% endfor %}
                        <th style="width:60px">Total</th>
                        <th style="width:50px">Avg</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr class="student-row">
                        <td class="rank-cell enlarged-rank"></td>
                        <td class="student-name text-truncate">{{ student.user.get_full_name }}</td>
                        {% for item in student.marks_list %}
                        <td class="mark-cell">
                            <input type="number"
                                   inputmode="numeric"
                                   step="1"
                                   min="0"
                                   max="{{ exam.max_mark }}"
                                   class="mark-input"
                                   name="mark_{{ student.id }}_{{ item.subject.id }}"
                                   value="{{ item.mark|default_if_none:'' }}"
                                   placeholder="">
                        </td>
                        <td class="rubric-cell" title="Rubric"></td>
                        {% endfor %}
                        <td class="total-cell"></td>
                        <td class="avg-cell"></td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-secondary">
                        <th colspan="2">Class Total</th>
                        {% for subject in subjects %}
                            <th class="subject-total" data-subject-id="{{ subject.id }}"></th><th></th>
                        {% endfor %}
                        <th class="class-total"></th>
                        <th class="class-avg"></th>
                    </tr>
                    <tr class="table-secondary">
                        <th colspan="2">Class Mean</th>
                        {% for subject in subjects %}
                            <th class="subject-mean" data-subject-id="{{ subject.id }}"></th><th></th>
                        {% endfor %}
                        <th class="class-total-mean"></th>
                        <th class="class-avg-mean"></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- MEAN SCORE GRAPH -->
    <div class="chart-container">
        <h6 class="chart-title mb-2">Subject Mean Scores</h6>
        <canvas id="summaryChart" height="180"></canvas>
    </div>

    <!-- FOOTER -->
    <div class="mt-3 text-center">
        <p><strong>School Motto:</strong> Beyond limits for Success</p>
        <p>Teacher Signature: ____________________ Date: ___________</p>
    </div>

</div>

<style>
/* ===== VISIBLE SCHOOL LOGO WATERMARKS ===== */
.watermark-container { position: relative; min-height: 100vh; }
.watermark {
    position: fixed !important;
    pointer-events: none;
    z-index: 1;
}
/* SCREEN */
.diagonal-1 { 
    top: 15%; left: 10%; 
    transform: rotate(-25deg) scale(1.2); 
    width: 280px !important; height: auto;
    opacity: 0.08;
}
.diagonal-2 { 
    top: 65%; right: 10%; 
    transform: rotate(25deg) scale(1.2); 
    width: 280px !important; height: auto;
    opacity: 0.08;
}
.horizontal-center {
    top: 45%; left: 50%; 
    transform: translateX(-50%) scale(1.1); 
    width: 320px !important; height: auto;
    opacity: 0.06;
}

/* ===== CLEAN HEADER ===== */
.print-header h6.exam-title {
    font-size: 16px !important;
    margin: 0;
    font-weight: 700;
}
.print-header .exam-info {
    font-size: 11px;
    opacity: 0.9;
}

/* ===== ENLARGED TABLE ===== */
.table-container { margin-bottom: 12px; }
.marks-table {
    font-size: 9px;
    margin: 0;
    border-collapse: collapse;
}
.marks-table th, .marks-table td {
    padding: 1px 2px;
    vertical-align: middle;
    border: 1px solid #999 !important;
    height: 26px;
}

/* ===== **BRIGHT GREEN ROW HIGHLIGHT - VERY VISIBLE** ===== */
.mark-cell:hover,
.mark-input:focus,
.mark-input:focus-within {
    background-color: #d4edda !important; /* Bright green */
    box-shadow: inset 0 0 0 2px #28a745 !important;
}

.mark-cell:hover ~ td,
.mark-input:focus ~ td,
.mark-input:focus-within ~ td,
.student-row:has(.mark-input:focus) td,
.student-row:has(.mark-cell:hover) td {
    background-color: #d4edda !important; /* Very visible green */
}

/* **HIGHLIGHT WHEN HOVERING STUDENT NAME OR RANK** */
.student-name:hover ~ td,
.rank-cell:hover ~ td,
.student-row:hover td {
    background-color: #d4edda !important; /* Bright green */
}

/* **ENHANCED VISIBILITY** */
.student-row:hover,
.student-row:has(.mark-input:focus),
.student-row:has(.mark-cell:hover) {
    outline: 3px solid #28a745 !important;
    outline-offset: -3px;
}

/* **ENSURE BORDERS STAY VISIBLE** */
.student-row:hover td,
.student-row:has(.mark-input:focus) td,
.student-row:has(.mark-cell:hover) td {
    border-color: #666 !important;
}

.student-name { 
    font-size: 12px !important; 
    font-weight: 600;
    padding-left: 5px !important; 
    max-width: 150px; 
    cursor: pointer;
}

.enlarged-rank {
    font-size: 13px !important;
    font-weight: 700 !important;
    min-width: 35px;
    cursor: pointer;
}

.total-cell, .avg-cell, .subject-total, .subject-mean,
.class-total, .class-avg, .class-total-mean, .class-avg-mean {
    font-weight: bold !important; 
    text-align: center; 
    font-size: 13px !important;
}

.mark-input {
    width: 32px !important;
    height: 22px !important;
    text-align: center;
    border: none;
    font-weight: bold;
    font-size: 11px;
    margin: 0;
    padding: 0;
    background: transparent;
}
.mark-input::-webkit-inner-spin-button,
.mark-input::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
.mark-input { -moz-appearance:textfield; }
.mark-input.invalid { background:#f8d7da !important; }

/* ===== RUBRIC COLORS ===== */
.rubric-cell.EE { 
    background-color: #d4edda !important; 
    color: #155724 !important; 
}
.rubric-cell.ME { 
    background-color: #cce7ff !important; 
    color: #004085 !important; 
}
.rubric-cell.AE { 
    background-color: #fff3cd !important; 
    color: #856404 !important; 
}
.rubric-cell.BE { 
    background-color: #f8d7da !important; 
    color: #721c24 !important; 
}

.rubric-cell { 
    font-size:8px; 
    font-weight:bold; 
    text-align:center; 
    padding: 0 !important; 
}
.subject-header, .rubric-header { 
    background:#e9ecef; 
    font-weight:bold; 
    text-align:center; 
    font-size: 8px;
}
.rank-1 { background:#c6efce !important; }
.rank-2 { background:#ffeb9c !important; }
.rank-3 { background:#ffc7ce !important; }

/* ===== CHART ===== */
.chart-container {
    width: 100%;
    height: 220px;
    position: relative;
}
.chart-title {
    font-size: 14px;
    font-weight: 600;
    color: #495057;
    margin: 0 0 8px 0;
}
#summaryChart {
    max-height: 180px !important;
    width: 100% !important;
}

/* ===== PRINT STYLES ===== */
@media print {
    body { 
        font-size: 9px !important; 
        margin: 5mm; 
        font-family: Arial, sans-serif !important;
        line-height: 1.1;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    
    .marks-table {
        border-collapse: collapse !important;
    }
    .marks-table th, .marks-table td {
        border: 1px solid #000 !important;
        height: 24px !important;
        padding: 1px 2px !important;
    }
    
    button, .no-print, 
    [class*="smarthub"], [id*="smarthub"],
    [class*="navbar"], [id*="navbar"],
    [class*="brand"], [id*="brand"],
    .navbar-brand, .app-title,
    header:not(.print-header), nav,
    .sidebar, .app-header,
    h1:not(.exam-title), .page-title { 
        display: none !important; 
    }
    
    .watermark {
        width: 260px !important;
        opacity: 0.12 !important;
    }
    .diagonal-1 { 
        top: 8% !important; 
        left: 3% !important; 
        transform: rotate(-25deg) scale(1.3) !important; 
    }
    .diagonal-2 { 
        top: 72% !important; 
        right: 3% !important; 
        transform: rotate(25deg) scale(1.3) !important; 
    }
    .horizontal-center { 
        top: 48% !important; 
        left: 50% !important; 
        transform: translateX(-50%) scale(1.2) !important; 
        opacity: 0.10 !important;
        width: 300px !important;
    }
    
    .print-header h6.exam-title {
        font-size: 15px !important;
        margin-bottom: 2px !important;
        color: black !important;
    }
    .print-header .exam-info {
        font-size: 10px !important;
        color: black !important;
    }
    
    .student-name { font-size: 11px !important; font-weight: 600 !important; }
    .enlarged-rank { font-size: 12px !important; font-weight: 700 !important; }
    .total-cell, .avg-cell, .subject-total, .subject-mean,
    .class-total, .class-avg, .class-total-mean, .class-avg-mean {
        font-size: 12px !important; font-weight: bold !important;
    }
    
    .mark-input {
        border: none !important;
        background: transparent !important;
        color: black !important;
        font-weight: bold !important;
        font-size: 10px !important;
    }
    
    .rubric-cell.EE { 
        background-color: #d4edda !important; 
        color: black !important; 
    }
    .rubric-cell.ME { 
        background-color: #cce7ff !important; 
        color: black !important; 
    }
    .rubric-cell.AE { 
        background-color: #fff3cd !important; 
        color: black !important; 
    }
    .rubric-cell.BE { 
        background-color: #f8d7da !important; 
        color: black !important; 
    }
    
    .chart-container { height: 200px !important; margin: 8px 0 !important; }
    .chart-title { font-size: 13px !important; margin-bottom: 6px !important; }
    #summaryChart { height: 160px !important; max-height: 160px !important; }
    
    @page {
        size: A4;
        margin: 8mm;
        @top-center { content: none !important; }
        @top-left { content: none !important; }
        @top-right { content: none !important; }
    }
}

@media (max-width: 768px) {
    .student-name { font-size: 11px !important; }
    .enlarged-rank { font-size: 12px !important; }
    .chart-container { height: 200px; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
Chart.register(ChartDataLabels);

document.addEventListener('DOMContentLoaded', () => {
    const table = document.getElementById('marks-table');
    const inputs = [...document.querySelectorAll('.mark-input')];
    const maxMark = {{ exam.max_mark }};
    const numStudents = {{ students|length }};
    const subjectsPerStudent = inputs.length / numStudents;
    const subjectTotals = {};
    
    let currentIndex = 0;

    if (inputs[0]) {
        inputs[0].focus();
        inputs[0].select();
    }

    inputs.forEach((input, i) => {
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const nextRowIndex = i + subjectsPerStudent;
                if (nextRowIndex < inputs.length) {
                    currentIndex = nextRowIndex;
                    inputs[currentIndex].focus();
                    inputs[currentIndex].select();
                }
            } else if (e.key === 'Tab') {
                e.preventDefault();
                if (e.shiftKey) {
                    const prevColIndex = i - 1;
                    if (prevColIndex >= 0) {
                        currentIndex = prevColIndex;
                        inputs[currentIndex].focus();
                        inputs[currentIndex].select();
                    }
                } else {
                    const nextColIndex = i + 1;
                    if (nextColIndex < inputs.length) {
                        currentIndex = nextColIndex;
                        inputs[currentIndex].focus();
                        inputs[currentIndex].select();
                    }
                }
            }
        });

        input.addEventListener('blur', e => {
            setTimeout(() => {
                if (document.activeElement !== input && currentIndex === i) {
                    input.focus();
                }
            }, 10);
        });

        input.addEventListener('focus', () => {
            currentIndex = i;
        });
    });

    function rubric(mark) {
        if (mark >= 80) return 'EE';
        if (mark >= 60) return 'ME';
        if (mark >= 40) return 'AE';
        return 'BE';
    }

    function calculate() {
        let classTotal = 0;
        Object.keys(subjectTotals).forEach(k => subjectTotals[k] = 0);

        [...table.tBodies[0].rows].forEach(row => {
            let total = 0;
            const rowInputs = row.querySelectorAll('.mark-input');
            
            rowInputs.forEach(input => {
                let val = input.value ? Math.round(parseFloat(input.value)) : 0;
                total += val;

                const rubricEl = input.parentElement.nextElementSibling;
                if (input.value) {
                    const grade = rubric(val);
                    rubricEl.textContent = grade;
                    rubricEl.title = `Rubric for ${val} marks`;
                    rubricEl.className = `rubric-cell ${grade}`;
                } else {
                    rubricEl.textContent = '';
                    rubricEl.className = 'rubric-cell';
                }

                if (val > maxMark) input.classList.add('invalid'); 
                else input.classList.remove('invalid');

                const subject = input.name.split('_').pop();
                subjectTotals[subject] = (subjectTotals[subject] || 0) + val;
            });
            
            row.querySelector('.total-cell').textContent = total;
            row.querySelector('.avg-cell').textContent = rowInputs.length ? Math.round(total / rowInputs.length) : 0;
            row.dataset.total = total;
            classTotal += total;
        });

        table.querySelectorAll('.subject-total').forEach(th => {
            const subjId = th.dataset.subjectId;
            th.textContent = subjectTotals[subjId] || '';
        });
        table.querySelectorAll('.subject-mean').forEach(th => {
            const subjId = th.dataset.subjectId;
            th.textContent = subjectTotals[subjId] ? Math.round(subjectTotals[subjId]/numStudents) : '';
        });
        table.querySelector('.class-total').textContent = classTotal;
        table.querySelector('.class-avg').textContent = numStudents ? Math.round(classTotal/numStudents) : 0;
    }

    function rank() {
        const rows = [...table.tBodies[0].rows].map((row, index) => ({
            row,
            total: parseFloat(row.dataset.total) || 0,
            originalIndex: index
        }));

        rows.sort((a, b) => {
            if (a.total === b.total) {
                return a.originalIndex - b.originalIndex;
            }
            return b.total - a.total;
        });

        rows.forEach(({row}, i) => {
            row.querySelector('.rank-cell').textContent = i + 1;
            row.classList.remove('rank-1', 'rank-2', 'rank-3');
            if (i === 0) row.classList.add('rank-1');
            if (i === 1) row.classList.add('rank-2');
            if (i === 2) row.classList.add('rank-3');
            table.tBodies[0].appendChild(row);
        });
    }

    function drawChart() {
        const labels = [{% for subject in subjects %}'{{ subject.short_name|default:subject.name }}',{% endfor %}];
        const data = [{% for subject in subjects %} Math.round((subjectTotals['{{ subject.id }}'] || 0) / {{ students|length }}) ,{% endfor %}];

        if (window.summaryChartObj) window.summaryChartObj.destroy();
        window.summaryChartObj = new Chart(document.getElementById('summaryChart'), {
            type: 'bar',
            data: { 
                labels, 
                datasets: [{ 
                    data, 
                    backgroundColor: 'rgba(54,162,235,0.8)',
                    borderColor: 'rgba(54,162,235,1)',
                    borderWidth: 1
                }] 
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                devicePixelRatio: 1.5,
                animation: { duration: 200 },
                plugins: { 
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        font: { size: 11, weight: 'bold' },
                        color: '#2c3e50',
                        formatter: value => value || ''
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        max: {{ exam.max_mark }},
                        ticks: { stepSize: 10, precision: 0 }
                    },
                    x: {
                        barPercentage: 0.85,
                        categoryPercentage: 1.0,
                        ticks: { maxRotation: 45 }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    inputs.forEach(input => {
        input.addEventListener('input', e => {
            calculate();
            clearTimeout(timer);
            timer = setTimeout(() => { rank(); drawChart(); }, 250);

            const [_, studentId, subjectId] = input.name.split('_');
            fetch("{% url 'academics:save_mark_ajax' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    student_id: studentId,
                    subject_id: subjectId,
                    exam_id: {{ exam.id }},
                    mark: input.value
                })
            }).then(res => res.json()).then(data => {
                if (data.status !== 'ok') console.error('Save failed', data);
            }).catch(console.error);
        });
    });

    let timer = null;
    calculate(); rank(); drawChart();
});

function downloadPDF() { window.print(); }
</script>
{% endblock %}
