{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h3>Enter Marks - Class {{ exam.school_class.name }}</h3>
    <p>
        <strong>Exam:</strong> {{ exam.name }} ({{ exam.term }} {{ exam.year }})<br>
        <strong>Max Marks:</strong> {{ exam.max_mark }}
    </p>

    {% if students %}
    <!-- Class list -->
    <form method="post">
        {% csrf_token %}
        <div class="table-responsive">
            <table id="marks-table" class="table table-bordered table-striped table-hover table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Rank</th>
                        <th>Student</th>
                        {% for subject in subjects %}
                            <th data-subject-id="{{ subject.id }}">{{ subject.short_name|default:subject.name }}</th>
                            <th>Rubric</th>
                        {% endfor %}
                        <th>Total</th>
                        <th>Average</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td class="rank-cell"></td>
                        <td>{{ student.user.get_full_name }}</td>
                        {% for item in student.marks_list %}
                            <td>
                                <input type="number"
                                       step="0.1"
                                       min="0"
                                       max="{{ exam.max_mark }}"
                                       class="form-control form-control-sm mark-input"
                                       name="marks_{{ student.id }}_{{ item.subject.id }}"
                                       value="{{ item.mark }}">
                            </td>
                            <td class="rubric-cell text-center"></td>
                        {% endfor %}
                        <td class="total-cell"></td>
                        <td class="average-cell"></td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-dark">
                    <tr>
                        <th colspan="2">Subject Total</th>
                        {% for subject in subjects %}
                            <th class="subject-total" data-subject-id="{{ subject.id }}"></th>
                            <th></th>
                        {% endfor %}
                        <th></th>
                        <th></th>
                    </tr>
                    <tr>
                        <th colspan="2">Subject Mean</th>
                        {% for subject in subjects %}
                            <th class="subject-mean" data-subject-id="{{ subject.id }}"></th>
                            <th></th>
                        {% endfor %}
                        <th></th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>
        <button type="submit" class="btn btn-success mt-2">Save Marks</button>
        <button type="button" class="btn btn-primary mt-2" onclick="downloadClassList()">Download Class List</button>
        <button type="button" class="btn btn-secondary mt-2" onclick="window.print();">Print Class List & Summary</button>
    </form>

    <!-- Subject summary below class list -->
    <h4 class="mt-4">Exam Summary (Subjects by Mean)</h4>
    <div class="chart-container">
        <canvas id="subject-summary-chart"></canvas>
    </div>

    {% else %}
    <div class="alert alert-warning">No students found in this class.</div>
    {% endif %}
</div>

<style>
.table td, .table th { padding: 0.1rem; font-size: 0.7rem; }
input.mark-input { width: 50px; height: calc(1rem + 2px); font-size: 0.65rem; }
.rubric-cell { font-weight:bold; text-align:center; }

/* Rubrics */
.rubric-ee { background-color: #28a745; color: #fff; }
.rubric-me { background-color: #ffc107; color: #212529; }
.rubric-ae { background-color: #fd7e14; color: #fff; }
.rubric-be { background-color: #dc3545; color: #fff; }

/* Top 3 ranks */
.rank-1 { background-color: gold !important; font-weight: bold; }
.rank-2 { background-color: silver !important; font-weight: bold; }
.rank-3 { background-color: #cd7f32 !important; font-weight: bold; }

/* Chart */
.chart-container { position: relative; width: 100%; height: 300px; }
@media (max-width:576px) { .chart-container { height: 200px; } }

/* Print */
@media print {
    body { font-size: 8pt; }
    table, canvas { width: 100% !important; page-break-inside: avoid; }
    .chart-container { height: 180mm; width: 260mm; }
    button, input { display: none; }
    @page { size: A4 landscape; margin: 5mm; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const table = document.getElementById('marks-table');

    function getRubric(mark){
        if (mark >= 80) return 'E.E';
        if (mark >= 60) return 'M.E';
        if (mark >= 40) return 'A.E';
        return 'B.E';
    }

    function getRubricClass(mark){
        if (mark >= 80) return 'rubric-ee';
        if (mark >= 60) return 'rubric-me';
        if (mark >= 40) return 'rubric-ae';
        return 'rubric-be';
    }

    function debounce(func, delay) {
        let timer;
        return function(...args){
            clearTimeout(timer);
            timer = setTimeout(() => func.apply(this, args), delay);
        }
    }

    function updateMarks(){
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const subjectSums = {};
        const subjectCounts = {};

        table.querySelectorAll('.mark-input').forEach(input => {
            const subjId = input.name.split('_')[2];
            if (!subjectSums[subjId]) subjectSums[subjId] = 0;
            if (!subjectCounts[subjId]) subjectCounts[subjId] = 0;
        });

        rows.forEach(row => {
            let total = 0;
            const inputs = row.querySelectorAll('.mark-input');
            inputs.forEach(input => {
                let val = parseFloat(input.value);
                if (isNaN(val)) val = 0;

                const subjId = input.name.split('_')[2];
                total += val;
                subjectSums[subjId] += val;
                subjectCounts[subjId] += 1;

                const rubricCell = input.parentElement.nextElementSibling;
                rubricCell.textContent = getRubric(val);
                rubricCell.className = 'rubric-cell ' + getRubricClass(val);
            });

            row.querySelector('.total-cell').textContent = total.toFixed(1);
            row.querySelector('.average-cell').textContent = (total/inputs.length).toFixed(2);
            row.dataset.total = total;
        });

        // Rank students
        rows.sort((a,b)=>parseFloat(b.dataset.total)-parseFloat(a.dataset.total));
        rows.forEach((row,i)=>{
            row.querySelector('.rank-cell').textContent = i+1;
            row.classList.remove('rank-1','rank-2','rank-3');
            if(i===0) row.classList.add('rank-1');
            if(i===1) row.classList.add('rank-2');
            if(i===2) row.classList.add('rank-3');
            row.parentElement.appendChild(row);
        });

        // Subject totals & means
        table.querySelectorAll('.subject-total').forEach(th => {
            const subjId = th.dataset.subjectId;
            th.textContent = subjectSums[subjId].toFixed(1);
        });
        table.querySelectorAll('.subject-mean').forEach(th => {
            const subjId = th.dataset.subjectId;
            th.textContent = (subjectSums[subjId]/subjectCounts[subjId]).toFixed(2);
        });

        // Subject summary chart
        const subjectData = [];
        table.querySelectorAll('th[data-subject-id]').forEach(th=>{
            const subjId = th.dataset.subjectId;
            const meanTh = table.querySelector(`.subject-mean[data-subject-id="${subjId}"]`);
            if(meanTh){
                const mean = parseFloat(meanTh.textContent);
                subjectData.push({name: th.textContent.trim(), mean});
            }
        });
        subjectData.sort((a,b)=>b.mean-a.mean);
        renderSubjectChart(subjectData);
    }

    function renderSubjectChart(subjectData){
        const ctx = document.getElementById('subject-summary-chart').getContext('2d');
        if(window.subjectChart) window.subjectChart.destroy();
        window.subjectChart = new Chart(ctx,{
            type:'bar',
            data:{
                labels: subjectData.map(s=>s.name),
                datasets:[{
                    label:'Mean Score',
                    data: subjectData.map(s=>s.mean),
                    backgroundColor:'rgba(54,162,235,0.7)',
                    borderColor:'rgba(54,162,235,1)',
                    borderWidth:1
                }]
            },
            options:{
                responsive:true,
                maintainAspectRatio:false,
                scales:{
                    y:{beginAtZero:true, max:{{ exam.max_mark }}},
                    x:{ticks:{autoSkip:false}}
                },
                plugins:{legend:{display:false}}
            }
        });
    }

    const debouncedUpdate = debounce(updateMarks,300);
    table.querySelectorAll('.mark-input').forEach(input => input.addEventListener('input', debouncedUpdate));

    updateMarks();

    // Download CSV
    window.downloadClassList = function(){
        const rows = Array.from(document.querySelectorAll('#marks-table tr'));
        const csv = rows.map(row=>{
            const cells = Array.from(row.querySelectorAll('th, td'));
            return cells.map(cell=>`"${cell.textContent.trim()}"`).join(',');
        }).join('\n');
        const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `ClassList_{{ exam.school_class.name }}_{{ exam.name }}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
});
</script>
{% endblock %}
