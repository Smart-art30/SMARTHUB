{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-3 watermark-container">

    <!-- SCHOOL LOGO HEADER -->
    <div class="d-flex align-items-center mb-3">
        
        <img src="{% if school_logo_url %}{{ school_logo_url }}{% else %}{% static 'images/school_logo.png' %}{% endif %}" 
             style="height:60px; margin-right:15px;">

        <div>
            <h5 class="mb-0">Marks Entry â€“ {{ exam.name }}</h5>
            <small>Class: {{ school_class }} | Max Mark: {{ exam.max_mark }}</small>
            <p>Facilitator (Class Teacher): {{ user.get_full_name }}</p>
        </div>
        <div class="ms-auto">
            <button onclick="window.print()" class="btn btn-sm btn-outline-dark">ðŸ–¨ Print</button>
            <button onclick="downloadPDF()" class="btn btn-sm btn-outline-primary">â¬‡ Download</button>
        </div>
    </div>

    <!-- WATERMARKS -->
    <img src="{% static 'images/school_logo.png' %}" class="watermark diagonal-1">
    <img src="{% static 'images/school_logo.png' %}" class="watermark diagonal-2">

    <!-- TABLE -->
    <div class="table-responsive">
        <table id="marks-table" class="table table-sm table-bordered marks-table">
            <thead>
                <tr class="table-primary">
                    <th>#</th>
                    <th class="text-start">Student</th>
                    {% for subject in subjects %}
                        <th class="subject-header"> {{ subject.short_name|default:subject.name }} </th>
                        <th class="rubric-header">R</th>
                    {% endfor %}
                    <th class="total-col">Total</th>
                    <th class="avg-col">Avg</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td class="rank-cell"></td>
                    <td class="student-name">{{ student.user.get_full_name }}</td>

                    {% for item in student.marks_list %}
                    <td>
                        <input type="number"
                               inputmode="numeric"
                               step="1"
                               min="0"
                               max="{{ exam.max_mark }}"
                               class="mark-input"
                               name="mark_{{ student.id }}_{{ item.subject.id }}"
                               value="{{ item.mark|default_if_none:'' }}"
                               placeholder="">
                    </td>
                    <td class="rubric-cell" title="Rubric"></td>
                    {% endfor %}

                    <td class="total-cell"></td>
                    <td class="avg-cell"></td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="table-secondary">
                    <th colspan="2">Class Total</th>
                    {% for subject in subjects %}
                        <th class="subject-total" data-subject-id="{{ subject.id }}"></th>
                        <th></th>
                    {% endfor %}
                    <th class="class-total"></th>
                    <th class="class-avg"></th>
                </tr>
                <tr class="table-secondary">
                    <th colspan="2">Class Mean</th>
                    {% for subject in subjects %}
                        <th class="subject-mean" data-subject-id="{{ subject.id }}"></th>
                        <th></th>
                    {% endfor %}
                    <th class="class-total-mean"></th>
                    <th class="class-avg-mean"></th>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- SUMMARY GRAPH -->
    <div class="mt-3" style="width: 35%; margin:auto;">
        <canvas id="summaryChart" height="60"></canvas>
    </div>

    <!-- FOOTER -->
    <div class="mt-3 text-center">
        <p><strong>School Motto:</strong> Beyond limits for Success</p>
        <p>Teacher Signature: ____________________</p>
    </div>

</div>

<style>
/* ===== WATERMARKS ===== */
.watermark-container { position: relative; }
.watermark {
    position: absolute;
    width: 250px;
    opacity: 0.06;
    pointer-events: none;
    z-index: 0;
}
.diagonal-1 { top: 30%; left: 20%; transform: rotate(-30deg); }
.diagonal-2 { top: 60%; left: 60%; transform: rotate(30deg); }

/* ===== TABLE STYLING ===== */
.marks-table th, .marks-table td {
    padding: 2px;
    vertical-align: middle;
    border: 1px solid #999;
}

.student-name { text-align: left; padding-left:5px; }

/* ===== INPUT FLAT & CENTERED ===== */
.mark-input {
    width: 35px;
    height: 25px;
    text-align: center;
    border: none;
    font-weight: bold;
    font-size: 12px;
    margin: 0;
    padding: 0;
}
.mark-input::-webkit-inner-spin-button,
.mark-input::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
.mark-input { -moz-appearance:textfield; }
.mark-input.invalid { background:#f8d7da; border-color:#dc3545; }

.rubric-cell { font-size:10px; font-weight:bold; text-align:center; }
.subject-header, .rubric-header { background:#e9ecef; font-weight:bold; text-align:center; }

.total-cell, .avg-cell, .subject-total, .subject-mean,
.class-total, .class-avg, .class-total-mean, .class-avg-mean {
    font-weight:bold; text-align:center;
}

/* RANK HIGHLIGHT */
.rank-1 { background:#c6efce; }
.rank-2 { background:#ffeb9c; }
.rank-3 { background:#ffc7ce; }

/* PRINT */
@media print {
    body { font-size: 10px; }
    button { display: none; }
    canvas { page-break-before: always; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    const table = document.getElementById('marks-table');
    const inputs = [...document.querySelectorAll('.mark-input')];
    const maxMark = {{ exam.max_mark }};
    const subjectTotals = {};

    /* ENTER â†’ NEXT CELL */
    inputs.forEach((input,i)=>{
        input.addEventListener('keydown',e=>{
            if(e.key==='Enter'){ e.preventDefault(); inputs[i+1]?.focus(); inputs[i+1]?.select(); }
        });
    });

    function rubric(mark){
        if(mark>=80) return 'EE';
        if(mark>=60) return 'ME';
        if(mark>=40) return 'AE';
        return 'BE';
    }

    function calculate(){
        let classTotal=0;
        // Reset subject totals
        Object.keys(subjectTotals).forEach(k => subjectTotals[k]=0);

        [...table.tBodies[0].rows].forEach(row=>{
            let total=0;
            const rowInputs=row.querySelectorAll('.mark-input');
            rowInputs.forEach(input=>{
                let val = input.value ? Math.round(parseFloat(input.value)) : 0;
                total += val;

                input.parentElement.nextElementSibling.textContent = input.value ? rubric(val) : '';
                input.parentElement.nextElementSibling.title = input.value ? `Rubric for ${val} marks` : '';

                if(val>maxMark) input.classList.add('invalid'); else input.classList.remove('invalid');

                const subject = input.name.split('_').pop();
                subjectTotals[subject] = (subjectTotals[subject] || 0) + val;
            });
            row.querySelector('.total-cell').textContent = total;
            row.querySelector('.avg-cell').textContent = Math.round(total / rowInputs.length);
            row.dataset.total = total;
            classTotal += total;
        });

        // Subject totals & mean
        table.querySelectorAll('.subject-total').forEach(th=>{
            const subjId = th.dataset.subjectId;
            th.textContent = subjectTotals[subjId] || '';
        });
        table.querySelectorAll('.subject-mean').forEach(th=>{
            const subjId = th.dataset.subjectId;
            th.textContent = subjectTotals[subjId] ? Math.round(subjectTotals[subjId]/{{ students|length }}) : '';
        });

        // Class totals
        table.querySelector('.class-total').textContent = classTotal;
        table.querySelector('.class-avg').textContent = Math.round(classTotal/{{ students|length }});
    }

    function rank(){
        const rows = [...table.tBodies[0].rows];
        rows.sort((a,b) => b.dataset.total - a.dataset.total);
        rows.forEach((row,i)=>{
            row.querySelector('.rank-cell').textContent = i+1;
            row.classList.remove('rank-1','rank-2','rank-3');
            if(i===0) row.classList.add('rank-1');
            if(i===1) row.classList.add('rank-2');
            if(i===2) row.classList.add('rank-3');
            table.tBodies[0].appendChild(row);
        });
    }

    function drawChart(){
        const labels = [{% for subject in subjects %}'{{ subject.short_name|default:subject.name }}',{% endfor %}];
        const data = [{% for subject in subjects %} subjectTotals['{{ subject.id }}'] || 0 ,{% endfor %}];

        if(window.summaryChartObj) window.summaryChartObj.destroy();
        window.summaryChartObj = new Chart(document.getElementById('summaryChart'), {
            type:'bar',
            data:{ labels, datasets:[{ data, backgroundColor:'rgba(54,162,235,0.7)'}]},
            options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, max:maxMark}}}
        });
    }

    // ===== Auto-save via AJAX =====
    inputs.forEach(input=>{
        input.addEventListener('input', e=>{
            calculate();
            clearTimeout(timer);
            timer=setTimeout(()=>{ rank(); drawChart(); },600);

            // Auto-save
            const [_, studentId, subjectId] = input.name.split('_');
            const markValue = input.value;
            fetch("{% url 'academics:save_mark_ajax' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    student_id: studentId,
                    subject_id: subjectId,
                    exam_id: {{ exam.id }},
                    mark: markValue
                })
            }).then(res=>res.json()).then(data=>{
                if(data.status !== 'ok'){
                    console.error('Mark save failed', data);
                }
            });
        });
    });

    let timer=null;
    calculate(); rank(); drawChart();
});

function downloadPDF(){ window.print(); }
</script>
{% endblock %}
