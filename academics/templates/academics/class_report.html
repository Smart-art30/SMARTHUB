{% extends 'base.html' %}
{% block content %}

<div class="text-center no-print mt-1">
    <button onclick="window.print();" class="btn btn-primary btn-sm">Print All Reports</button>
</div>

<style>
body {
    font-family: "Calibri", "Verdana", Arial, sans-serif;
    margin: 0;
    padding: 10px;
    font-size: 0.8rem;
}

.student-photo {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border: 1px solid #ccc;
}

.table-sm td, .table-sm th {
    padding: 0.25rem;
    font-size: 0.75rem;
}

.table-bordered th, .table-bordered td {
    border: 1px solid #333 !important;
}

.trend-up { color: green; font-weight: bold; }
.trend-down { color: red; font-weight: bold; }
.trend-same { color: gray; font-weight: bold; }

.remark-exceeding { color: green; font-weight: bold; text-align: left; }
.remark-meeting { color: blue; font-weight: bold; text-align: left; }
.remark-approaching { color: orange; font-weight: bold; text-align: left; }
.remark-below { color: red; font-weight: bold; text-align: left; }

.header, .footer { text-align: center; font-size: 0.75rem; }
.school-logo { height: 50px; object-fit: contain; margin-bottom: 2px; }

.sign-space { border-top: 1px solid #000; width: 150px; text-align: center; margin-top: 5px; font-size: 0.7rem; }
.feedback-box { border: 1px solid #000; padding: 2px; height: 50px; font-size: 0.7rem; margin-bottom: 2px; }
.chart-container { width: 100%; max-width: 400px; height: 120px; margin: 5px auto; }

.center-dates { text-align: center; font-size: 0.75rem; margin-top: 3px; }

@media print {
    @page { size: A4; margin: 10mm; }
    body { font-size: 9pt; }
    .no-print { display: none; }

    .card {
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Footer at bottom */
        page-break-inside: avoid;  
        page-break-after: always;  
        width: 100%;
        min-height: 280mm; /* Ensure content + footer fit on A4 */
        overflow: hidden;
    }

    .table-sm td, .table-sm th { padding: 0.2rem; font-size: 0.7rem; }
    .chart-container { height: 100px; }
}
</style>

{% for report in all_student_reports %}
<div class="card mb-4 p-3" id="report-{{ report.student.id }}">

    <!-- Header -->
    <div class="header mb-1">
        {% if school.logo %}
            <img src="{{ school.logo.url }}" alt="{{ school.name }}" class="school-logo">
        {% endif %}
        <h3 style="margin:0;">{{ school.name }}</h3>
        <p style="margin:0;"><em>{{ school.motto|default:"Beyond Limits For Success" }}</em></p>
        <p style="margin:0; font-size:0.7rem;">P.O BOX: 1298-00232 | Tel: 0722-267-382 | Email: annaluciaacademy10@gmail.com</p>
        <h4 style="margin:2px 0;">Report Card</h4>
    </div>

    <!-- Student Info -->
    <div class="d-flex align-items-center mb-1" style="font-size:0.75rem;">
        {% if report.student.photo %}
            <img src="{{ report.student.photo.url }}" alt="{{ report.student.user.get_full_name }}" class="rounded me-2 student-photo">
        {% else %}
            <div class="rounded bg-secondary text-white d-flex justify-content-center align-items-center me-2 student-photo" style="font-size:0.6rem;">
                No Photo
            </div>
        {% endif %}
        <div>
            <p style="margin:0;"><strong>Student:</strong> {{ report.student.user.get_full_name }}</p>
            <p style="margin:0;"><strong>Class:</strong> {{ school_class.name }}</p>
            <p style="margin:0;"><strong>Position in Class:</strong> {{ report.rank }}</p>
            <p style="margin:0;"><strong>Facilitator:</strong> {{ report.facilitator }}</p>
        </div>
    </div>

    <!-- Marks Table -->
    <div class="table-responsive mb-1">
        <table class="table table-bordered table-sm text-center">
            <thead class="table-light">
                <tr>
                    <th class="text-start">Subject</th>
                    {% for exam in exams %}
                        <th>{{ exam.name }}<br>({{ exam.term }})</th>
                    {% endfor %}
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody>
                {% for row in report.report_rows_with_trends %}
                <tr>
                    <td class="text-start">{{ row.subject }}</td>
                    {% for mark in row.marks %}
                        <td>
                            {{ mark.mark }}
                            {% if mark.trend == 'up' %}
                                <span class="trend-up">↑</span>
                            {% elif mark.trend == 'down' %}
                                <span class="trend-down">↓</span>
                            {% else %}
                                <span class="trend-same">→</span>
                            {% endif %}
                        </td>
                    {% endfor %}
                    <td>
                        {% if row.remarks == 'Exceeding Expectation' %}
                            <span class="remark-exceeding">{{ row.remarks }}</span>
                        {% elif row.remarks == 'Meeting Expectation' %}
                            <span class="remark-meeting">{{ row.remarks }}</span>
                        {% elif row.remarks == 'Approaching Expectation' %}
                            <span class="remark-approaching">{{ row.remarks }}</span>
                        {% else %}
                            <span class="remark-below">{{ row.remarks }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-info text-center">
                <tr>
                    <td class="text-start"><strong>Total Marks</strong></td>
                    {% for total in report.exam_totals %}
                        <td><strong>{{ total }}</strong></td>
                    {% endfor %}
                    <td></td>
                </tr>
                <tr>
                    <td class="text-start"><strong>Average</strong></td>
                    {% for avg in report.exam_averages %}
                        <td>{{ avg }}</td>
                    {% endfor %}
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Trend Graph -->
    <div class="chart-container mb-1">
        <canvas id="chart-{{ forloop.counter }}"></canvas>
    </div>

    <!-- Feedback Box -->
    <div style="font-size:0.75rem;">
        <p style="margin:0;"><strong>Core Competence Achieved & Facilitator's Feedback:</strong></p>
        <div class="feedback-box"></div>
        <p class="center-dates"><strong>Closing Date:</strong> __________ &nbsp;&nbsp; <strong>Opening Date:</strong> __________</p>
    </div>

    <!-- Signatures -->
    <div class="d-flex justify-content-between mt-1" style="font-size:0.75rem;">
        <div class="text-center"><div class="sign-space">Headteacher's Signature</div></div>
        <div class="text-center"><div class="sign-space">Facilitator's Signature</div></div>
    </div>

    <!-- Footer / Copyright -->
    <div class="footer">
        &copy; 2026 {{ school.name }}. All Rights Reserved.
    </div>

</div>
{% endfor %}

<!-- Print Button -->
<div class="text-center no-print mt-1">
    <button onclick="window.print();" class="btn btn-primary btn-sm">Print All Reports</button>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
{% for report in all_student_reports %}
var ctx{{ forloop.counter }} = document.getElementById('chart-{{ forloop.counter }}').getContext('2d');
new Chart(ctx{{ forloop.counter }}, {
    type: 'line',
    data: {
        labels: [{% for exam in exams %}'{{ exam.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Total Marks',
            data: [{% for avg in report.exam_averages %}{{ avg }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            borderColor: 'rgba(54,162,235,1)',
            backgroundColor: 'rgba(54,162,235,0.2)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
    }
});
{% endfor %}
</script>

{% endblock %}
